<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Report</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f7fc;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #3284f7;
      padding: 20px;
    }

    .upasthiti-title {
      position: absolute;
      top: 10px;
      left: 20px;
      font-family: 'Copperplate', 'Papyrus', fantasy;
      font-size: 2em;
      color: #3284f7;
    }

    .search-container {
      text-align: center;
      margin-bottom: 10px;
    }

    .search-container input {
      padding: 8px;
      font-size: 16px;
      width: 200px;
    }

    h2 {
      font-size: 1.2em;
      color: #192f86;
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding-left: 20px;
    }

    .calendar-icon {
      cursor: pointer;
      margin-left: 10px;
      font-size: 1.2em;
      color: #3284f7;
    }

    .calendar-container {
      display: none;
      padding: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin: 10px 0;
    }

    th, td {
      border: 1px solid #000;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #d1e5f6;
      color: black;
    }

    .present { background-color: #28a745; color: white; }
    .absent { background-color: #dc3545; color: white; }

    .back-to-list-container {
      text-align: center;
      margin-top: 30px;
    }

    a {
      text-decoration: none;
      background-color: #ba6418;
      color: white;
      padding: 12px 20px;
      border-radius: 5px;
      display: inline-block;
    }

    a:hover { background-color: #218838; }
  </style>
</head>
<body>
  <div class="upasthiti-title">UPASTHITI</div>
  <h1>Attendance Report</h1>

  <!-- Search Bar -->
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Search student..." onkeyup="searchStudents()">
  </div>

  {% for student_name, attendance_records in grouped_report.items() %}
    <h2>
      {{ student_name }} - {{ attendance_percentages[student_name] }}%
      <span class="calendar-icon" onclick="toggleCalendar('{{ student_name }}')">ðŸ“…</span>
    </h2>
    <div id="calendar-container-{{ student_name }}" class="calendar-container">
      <div id="calendar-{{ student_name }}"></div>
    </div>
    <table class="attendance-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for date, status in attendance_records %}
          <tr>
            <td>{{ date }}</td>
            <td class="{% if status == 'Present' %}present{% elif status == 'Absent' %}absent{% endif %}">
              {{ status }}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endfor %}

  <div class="back-to-list-container">
    <a href="{{ url_for('index') }}">Back to Student List</a>
  </div>

  <script>
    function searchStudents() {
      let input = document.getElementById("searchInput").value.toLowerCase();
      let studentHeaders = document.querySelectorAll("h2");
      let tables = document.querySelectorAll(".attendance-table");

      studentHeaders.forEach((header, index) => {
        let studentName = header.textContent.toLowerCase();
        let isVisible = studentName.includes(input);

        header.style.display = isVisible ? "block" : "none";
        tables[index].style.display = isVisible ? "table" : "none";
      });
    }

    function toggleCalendar(studentName) {
      const container = document.getElementById(`calendar-container-${studentName}`);
      if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        openCalendar(studentName);
      } else {
        container.style.display = 'none';
      }
    }

    function openCalendar(studentName) {
      const calendarEl = document.getElementById(`calendar-${studentName}`);
      const attendanceData = JSON.parse('{{ grouped_report | tojson | safe }}');
      const records = attendanceData[studentName] || [];

      const absentDates = records.filter(([date, status]) => status === 'Absent').map(([date]) => date);
      const presentDates = records.filter(([date, status]) => status === 'Present').map(([date]) => date);

      flatpickr(calendarEl, {
        inline: true,
        enable: [...absentDates, ...presentDates], // Only mark attendance dates
        disable: [function(date) {
          return date.getDay() === 0; // Disable Sundays
        }],
        disableMobile: true,
        dateFormat: "Y-m-d",
        onDayCreate: function(dObj, dStr, fp, dayElem) {
          const dateStr = fp.formatDate(dayElem.dateObj, "Y-m-d");

          // Darken all numbers
          dayElem.style.color = 'black';

          // Apply colors based on attendance status
          if (absentDates.includes(dateStr)) {
            dayElem.style.backgroundColor = '#dc3545'; // Red for Absent
          } else if (presentDates.includes(dateStr)) {
            dayElem.style.backgroundColor = '#28a745'; // Green for Present
          }
        }
      });
    }
  </script>
</body>
</html>
